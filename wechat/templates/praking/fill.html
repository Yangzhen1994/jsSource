<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="text/html;charset=UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <meta http-equiv="Pragma" content="no-cache"/>
    <meta http-equiv="Cache-Control" content="no cache"/>
    <meta http-equiv="Expires" content="0"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no"/>
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <title>在线填报</title>
    <link rel="stylesheet" href="https://cdn.bootcss.com/weui/1.1.2/style/weui.min.css">
    <link rel="stylesheet" href="https://cdn.bootcss.com/jquery-weui/1.2.0/css/jquery-weui.min.css">
    <script src="../../js/frame/jquery-1.8.2.min.js"></script>
    <script src="../../js/DcUtils.js"></script>
    <script src="../../js/HttpUtils.js"></script>
    <script src="../../js/common.js"></script>
    <link rel="stylesheet" href="../../css/common.css">
    <link rel="stylesheet" href="../../css/parking.css">
</head>
<body>
    <div class="mock_margin"></div>
    <form id="fill_form">
        <h4>地下车库停车申请表</h4>
        <!--基本信息-->
        <section class="base_message">
            <div class="tit">基本信息</div>
            <div class="paddingLR">
                <div class="spe">
                    <label for="user_name">车主姓名：</label>
                    <input id="user_name" label="车主姓名" class="require" type="text" value="" placeholder=""/>
                </div>
                <div class="spe">
                    <label for="user_id">身份证号：</label>
                    <input id="user_id" label="身份证号" class="require" type="text" value="" placeholder=""/>
                </div>
                <div class="molabel fl">
                    <label for="tel1">联系电话1：</label>
                    <input id="tel1" label="联系电话1" class="require" type="text" value="" placeholder=""/>
                </div>
                <div class="molabel fr">
                    <label for="tel2">联系电话2：</label>
                    <input id="tel2" type="text" value="" placeholder=""/>
                </div>
                <div class="molabel fl">
                    <label for="car_num">车牌号码：</label>
                    <input id="car_num" label="车牌号码" class="require" type="text" value="" placeholder=""/>
                </div>
                <div class="molabel fr">
                    <label>车辆类型：</label>
                    <select id="car_type">
                        <option value="">微型车</option>
                        <option value="">小型车</option>
                        <option value="">中型车</option>
                        <option value="">大型车</option>
                    </select>
                </div>
                <div class="molabel fl">
                    <label>租约时间：</label>
                    <select id="rent_time">
                        <option value="">1个月</option>
                        <option value="">2个月</option>
                        <option value="">3个月</option>
                        <option value="">6个月</option>
                        <option value="">9个月</option>
                        <option value="">12个月</option>
                        <option value="">24个月</option>
                        <option value="">36个月</option>
                    </select>
                </div>
                <div class="molabel fr">
                    <label>月租金：</label>
                    <input id="month_money" class="readonly" readonly type="text" value="" placeholder=""/>
                </div>
                <div class="car_kinds">
                    <p><i class="star">*</i>车辆属性</p>
                    <ul>
                        <li>本小区承租人自有车辆</li>
                        <li>承租人单位车辆</li>
                        <li>非小区住户车辆</li>
                    </ul>
                </div>
                <div class="spe">
                    <label for="user_adress">车主地址：</label>
                    <input id="user_adress" type="text" value="" placeholder=""/>
                </div>
                <div class="spe">
                    <label for="company_name">单位名称：</label>
                    <input id="company_name" type="text" value="" placeholder=""/>
                </div>
            </div>
        </section>
        <!--申请材料-->
        <section class="material">
            <div class="tit">申请材料</div>
            <div class="img_box clearfix" id="img_box1">
                <span>单位证明</span>
                <ul class="img_upload_box" id="img_upload_box1"></ul>
                <div class="add_box">
                    <span>添加图片</span>
                    <input class="weui-uploader__input zjxfjs_file" type="file" accept="image/*" multiple="">
                </div>
            </div>
            <div class="img_box clearfix" id="img_box2">
                <span>租赁合同</span>
                <ul class="img_upload_box" id="img_upload_box2"></ul>
                <div class="add_box">
                    <span>添加图片</span>
                    <input class="weui-uploader__input zjxfjs_file" type="file" accept="image/*" multiple="">
                </div>
            </div>
            <div class="img_box clearfix" id="img_box3">
                <span>车主身份证</span>
                <ul class="img_upload_box" id="img_upload_box3"></ul>
                <div class="add_box">
                    <span>添加图片</span>
                    <input class="weui-uploader__input zjxfjs_file" type="file" accept="image/*" multiple="">
                </div>
            </div>
            <div class="img_box clearfix" id="img_box4">
                <span>行驶证</span>
                <ul class="img_upload_box" id="img_upload_box4"></ul>
                <div class="add_box">
                    <span>添加图片</span>
                    <input class="weui-uploader__input zjxfjs_file" type="file" accept="image/*" multiple="">
                </div>
            </div>
        </section>
        <!--预约信息-->
        <section class="appointment">
            <div class="tit">预约信息</div>
            <div class="date_area clearfix">
                <p><i class="star">*</i>预约办理日期（10天内）：</p>
                <div class="date_wrap">
                    <div class="fl date_item current" >
                        <div class="date_item_week"></div>
                        <div class="date_item_num"></div>
                    </div>
                    <div class="fl date_item" >
                        <div class="date_item_week"></div>
                        <div class="date_item_num">
                        </div>
                    </div>
                    <div class="fl date_item" >
                        <div class="date_item_week"></div>
                        <div class="date_item_num">
                        </div>
                    </div>
                    <div class="fl date_item" >
                        <div class="date_item_week"></div>
                        <div class="date_item_num">
                        </div>
                    </div>
                    <div class="fl date_item" >
                        <div class="date_item_week"></div>
                        <div class="date_item_num">
                        </div>
                    </div>
                    <div class="fl date_item" >
                        <div class="date_item_week"></div>
                        <div class="date_item_num">
                        </div>
                    </div>
                    <div class="fl date_item" >
                        <div class="date_item_week"></div>
                        <div class="date_item_num">
                        </div>
                    </div>
                    <div class="fl date_item" >
                        <div class="date_item_week"></div>
                        <div class="date_item_num">
                        </div>
                    </div>
                    <div class="fl date_item" >
                        <div class="date_item_week"></div>
                        <div class="date_item_num">
                        </div>
                    </div>
                    <div class="fl date_item" >
                        <div class="date_item_week"></div>
                        <div class="date_item_num">
                        </div>
                    </div>
                </div>
            </div>
            <div class="molabel time_slot">
                <label><i class="star">*</i>预约办理时间段：</label>
                <select id="time_slot">
                    <option endtime="10" value="9:00 - 10:00">9:00 - 10:00</option>
                    <option endtime="11" value="10:00 - 11:00">10:00 - 11:00</option>
                    <option endtime="12" value="11:00 - 12:00">11:00 - 12:00</option>
                    <option endtime="15" value="14:00 - 15:00">14:00 - 15:00</option>
                    <option endtime="16" value="15:00 - 16:00">15:00 - 16:00</option>
                    <option endtime="17" value="16:00 - 17:00">16:00 - 17:00</option>
                    <option endtime="17" value="17:00 - 17:30">17:00 - 17:30</option>
                </select>
            </div>
            <div class="molabel add_info">
                <label>申报说明：</label>
                <textarea maxlength="150" placeholder="为方便我们能为您提供更好的服务，请填写说明，字数最多150字"></textarea>
            </div>
        </section>
    </form>
    <div class="btns group1">
        <button class="clear" onclick="window.history.go(-1)">上一步</button>
        <button class="confirm next">下一步</button>
    </div>
    <div class="btns group2" style="display: none">
        <button class="clear prev">上一步</button>
        <button class="confirm submit">提交</button>
    </div>
</body>
<script src="https://cdn.bootcss.com/jquery-weui/1.2.0/js/jquery-weui.min.js"></script>
<script>
    //缓存渲染登记类型和月租金
    var kinds_num = sessionStorage.getItem("kinds_num");
    $(".car_kinds ul li").eq(kinds_num).addClass("choosed").siblings("li").removeClass("choosed");
    if(kinds_num == 0){
        $("#month_money").val("300 元/月");
    }else{
        $("#month_money").val("500 元/月");
    }
    //下一步
    $(".next").click(function(){
        if(!validate()){return};
        setTimeout(function () {
            nextfun();
        },200)
    });
    //上一步
    $(".prev").click(function(){
        prevfun();
    });
    function nextfun(){
        $("#user_name").attr("readonly",true).addClass("readonly");
        $("#user_id").attr("readonly",true).addClass("readonly");
        $("#tel1").attr("readonly",true).addClass("readonly");
        $("#tel2").attr("readonly",true).addClass("readonly");
        $("#car_num").attr("readonly",true).addClass("readonly");
        $("#car_type").attr('disabled',true).addClass("readonly");
        $("#month_money").attr("readonly",true).addClass("readonly");
        $("#rent_time").attr("disabled",true).addClass("readonly");
        $("#user_adress").attr("readonly",true).addClass("readonly");
        $("#company_name").attr("readonly",true).addClass("readonly");
        $(".del_btn").hide();
        $(".add_box").hide();
        $(".date_wrap .date_item").unbind("click");
        $("#time_slot").attr('disabled',true).addClass("readonly");
        $(".add_info textarea").attr("readonly",true).addClass("readonly");
        $(".group1").hide();
        $(".group2").show();
        $(window).scrollTop(0);
    }
    function prevfun(){
        $("#user_name").attr("readonly",false).removeClass("readonly");
        $("#user_id").attr("readonly",false).removeClass("readonly");
        $("#tel1").attr("readonly",false).removeClass("readonly");
        $("#tel2").attr("readonly",false).removeClass("readonly");
        $("#car_num").attr("readonly",false).removeClass("readonly");
        $("#car_type").attr('disabled',false).removeClass("readonly");
        $("#rent_time").attr("disabled",false).removeClass("readonly");
        $("#user_adress").attr("readonly",false).removeClass("readonly");
        $("#company_name").attr("readonly",false).removeClass("readonly");
        $(".del_btn").show();
        $(".add_box").show();
        $('.date_item').click(function () {
            if ($(this).hasClass('no_choosed')) {
                return false
            }
            $(this).addClass('current')
            $(this).siblings().removeClass('current')
        })
        $("#time_slot").attr('disabled',false).removeClass("readonly");
        $(".add_info textarea").attr("readonly",false).removeClass("readonly");
        $(".group1").show();
        $(".group2").hide();
        $(window).scrollTop(0);
    }
    //提交
    $(".submit").click(function(){
        $.confirm({
            title: '提示',
            text: '检查内容是否正确，确认提交？',
            onOK: function () {
                setTimeout(function () {
                    window.location.href ="success.html";
                },500)
            },
            onCancel: function () {
            }
        });
    });
    //表单验证
    function validate(){
        //验证非空
        var objs = $(".require");
        for(var i=0;i<objs.length;i++){
            var obj = objs.eq(i);
            if($.trim(obj.val())==""){
                var label_name= obj.attr("label");
                $.alert(label_name+"不能为空！",function(){
                    obj.focus();
                });
                stopScroll($('.weui-mask'))
                obj.focus();
                return false;
            }
        }

        //校验身份证
        if(!DcUtils.isIdCard($("#user_id").val())){
            $.alert("请输入正确的身份证号！",function(){
                $("#user_id").focus();
            });
            stopScroll($('.weui-mask'))
            return false;
        }

        //校验手机号码
        if(!DcUtils.isMobile($("#tel1").val())){
            $.alert("手机号码格式不正确",function(){
                $("#tel1").focus();
            });
            stopScroll($('.weui-mask'))
            return false;
        }

        //校验上传图片长度，单位证明至少1张，其他至少2张
        if($("#img_upload_box1").length>0 && $("#img_upload_box1 li").length<1){
            $.alert("请补充您的单位证明！");
            stopScroll($('.weui-mask'))
            return false;
        }
        if($("#img_upload_box2").length>0 && $("#img_upload_box2 li").length<2){
            $.alert("请补充您的租赁合同，<br/>至少提供两张！");
            stopScroll($('.weui-mask'))
            return false;
        }
        if($("#img_upload_box3").length>0 && $("#img_upload_box3 li").length<2){
            $.alert("请补充您的身份证明，<br/>至少提供正反面两张！");
            stopScroll($('.weui-mask'))
            return false;
        }
        if($("#img_upload_box4").length>0 && $("#img_upload_box4 li").length<2){
            $.alert("请补充您的驾驶证件，<br/>至少提供两张！");
            stopScroll($('.weui-mask'))
            return false;
        }

        //选择当天时，时间段必须在当前之后
        if($(".date_wrap .date_item").eq(0).hasClass("current")){
            if($("#time_slot").find("option:selected").attr("endtime")<=getNowHours()){
                $.alert("预约时间不合理，请重新选择！");
                stopScroll($('.weui-mask'))
                return false;
            }
        }

        return true;
    }
    //获取当前时间：h
    function getNowHours() {
        var date = new Date();
        return date.getHours();
    }
    //图片上传调用
    imgUpload('#img_upload_box1');
    imgUpload('#img_upload_box2');
    imgUpload('#img_upload_box3');
    imgUpload('#img_upload_box4');
    //图片上传方法封装,参数ele为展示上传图片的容器ID
    function imgUpload(ele) {
        var $uploaderFiles = $(ele),
            newNode = '<li><img src=#url#><span class="del_btn">x</span></li>',
            $uploaderInput = $(ele).siblings(".add_box").find("input"),
            imgList = [],
            count=0,
            formData = new FormData();
        $uploaderInput.on("change", function(e) {
            var src, url = window.URL || window.webkitURL || window.mozURL, files = e.target.files;
            if(count>=8 || files.length>3){
                $.alert('最多上传8张图片');
                stopScroll($('.weui-mask'))
                return false;
            }
            var isOver = false;
            for(var i = 0, len = files.length; i < len; ++i) {
                var file = files[i];
                imgList.forEach(function (item,index) {
                    if(file.size == item.size && file.name == item.name){
                        isOver = true
                        $.alert('图片重复',function () {
                            isOver = false
                            $uploaderInput.val('');
                        });
                        stopScroll($('.weui-mask'))
                        return false;
                    }
                })
                if(isOver){
                    return
                }
                imgList.push(file);
                console.log(imgList);
                if (file.size > 5* 1024 * 1024) {
                    $.alert('请上传不超过5M的图片');
                    stopScroll($('.weui-mask'))
                    return false;
                }
                transformFileToFormData(file)

                if(url) {
                    src = url.createObjectURL(file);
                } else {
                    src = e.target.result;
                }
                count++;
                console.log(count);
                $uploaderFiles.append($(newNode.replace('#url#', src)));
                $.ajax(
                    {
                        type: "POST",//通常会用到两种：GET,POST。默认是：GET
                        url:'90',//(默认: 当前页地址) 发送请求的地址
                        data: formData,
                        contentType: false, // 注意这里应设为false
                        processData: false,   //  告诉jquery不要处理发送的数据
                        success: function(res){
                        }, //请求成功
                        error:function(){
                        },//请求出错
                        complete: function (res) {
                            $uploaderInput.val('');
                        }//请求完成
                    });
            }

        });
        //删除图片
        var index; //第几张图片
        $uploaderFiles.on("click", ".del_btn", function() {
            index = $(this).parents("li").index();
            $(this).parents("li").remove();
            console.log(imgList)
            imgList.splice(index,1);
            console.log(imgList)
            count--;
        });
        function transformFileToFormData(file) {
            // 自定义formData中的内容
            // type
            formData.append('type', file.type);
            // size
            formData.append('size', file.size || "image/jpeg");
            // name
            formData.append('name', file.name);
            // lastModifiedDate
            formData.append('lastModifiedDate', file.lastModifiedDate);
            // append 文件
            formData.append('files', file);

        }
    }

    //看房日期
    //看房日期 1-仅周末，2-仅工作日，3-随时看房
    var lookTime = 3
    lookDateChoose(10);
    function lookDateChoose(dayNum) {
        var dateArr = []
        var dayArr = []
        var dateObj = new Date();
        //获取年月日
        var year = dateObj.getFullYear()
        var month = dateObj.getMonth() + 1
        var date = dateObj.getDate()
        for (var i = 0; i < dayNum; i++) {
            dateArr.push(new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate() + i));   //把未来几天的时间放到数组里
            var day = "星期" + "日一二三四五六".charAt(dateArr[i].getDay());
            dayArr.push({
                week: day,
                date: (dateArr[i].getMonth() + 1) + '-' + dateArr[i].getDate()
            })
        }
        dayArr.forEach(function (item, index) {
            $('.date_item').eq(index).attr('date', item.date)
            $('.date_item').eq(index).find('.date_item_week').text(item.week)
            if (item.week == '星期六' || item.week == '星期日') {
                $('.date_item').eq(index).addClass('week')
            }
            var ndate = item.date.split('-')[1]
            if (ndate < 10) {
                var date = '0' + ndate
            } else {
                var date = ndate
            }
            $('.date_item').eq(index).find('.date_item_num').text(date)
            $('.date_item').eq(0).find('.date_item_num').text('今天')
        })

        $('.date_item').click(function () {
            if ($(this).hasClass('no_choosed')) {
                return false
            }
            $(this).addClass('current')
            $(this).siblings().removeClass('current')
        })
    }
</script>
</html>